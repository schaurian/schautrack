<%- include('partials/header', { title: 'Settings' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Target</p>
          <h2>Daily goal</h2>
        </div>
        <a href="/dashboard" class="ghost">Back to dashboard</a>
      </div>
      <form action="/goal" method="POST" class="stack">
        <label class="field">
          <span>Goal in kcal</span>
          <input type="number" name="goal" min="0" placeholder="e.g. 2200" value="<%= user.daily_goal || '' %>">
        </label>
        <button type="submit" class="primary">Save goal</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Two-factor</p>
          <h2>Protect your account</h2>
        </div>
      </div>

      <div class="panel-toggle">
        <p class="muted small">Manage authenticator setup and 2FA status.</p>
        <button type="button" class="ghost" data-totp-toggle aria-expanded="false">Show details</button>
      </div>

      <div class="stack hidden" data-totp-body>
        <% if (user.totp_enabled) { %>
          <div class="alert success">2FA is enabled for <%= user.email %>.</div>
          <p class="muted">Use your authenticator app to generate codes. To disable, confirm with a current code.</p>
          <form action="/2fa/disable" method="POST" class="stack compact">
            <label class="field">
              <span>Current 2FA code</span>
              <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
            </label>
            <button type="submit" class="ghost danger">Disable 2FA</button>
          </form>
        <% } else if (hasTempSecret) { %>
          <div class="alert">Scan the QR code or copy the setup link, then confirm with a 6-digit code.</div>
          <div class="grid two">
            <div class="qr">
              <% if (qrDataUrl) { %>
                <img src="<%= qrDataUrl %>" alt="2FA QR code">
              <% } %>
              <% if (otpauthUrl) { %>
                <code class="muted break"><%= otpauthUrl %></code>
              <% } %>
            </div>
            <form action="/2fa/enable" method="POST" class="stack compact">
              <label class="field">
                <span>6-digit code</span>
                <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
              </label>
              <button type="submit" class="primary">Activate 2FA</button>
            </form>
          </div>
        <% } else { %>
          <div class="alert">Add an authenticator app (like 1Password, Authy, Google Authenticator) for stronger protection.</div>
          <a class="primary" href="/2fa/setup">Start setup</a>
        <% } %>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Sharing</p>
        <h2>Link accounts</h2>
      </div>
      <div class="chip muted">Up to <%= maxLinks %></div>
    </div>

    <% if (linkFeedback) { %>
      <div class="alert <%= linkFeedback.type === 'error' ? 'danger' : 'success' %>"><%= linkFeedback.message %></div>
    <% } %>

    <form action="/settings/link/request" method="POST" class="stack link-form">
      <label class="field">
        <span>Invite by email</span>
        <input type="email" name="email" placeholder="friend@example.com" required <%= availableSlots === 0 ? 'disabled' : '' %>>
      </label>
      <div class="muted small">
        Linked accounts: <%= maxLinks - availableSlots %>/<%= maxLinks %>. <%= availableSlots === 0 ? 'Remove one to invite another.' : `You can invite ${availableSlots} more.` %>
      </div>
      <div>
        <button type="submit" class="primary" <%= availableSlots === 0 ? 'disabled' : '' %>>Send request</button>
      </div>
    </form>

    <div class="grid two">
      <div class="data-card stack">
        <div class="table-row header">
          <div>Incoming requests</div>
          <div></div>
          <div></div>
        </div>
        <% if (!incomingRequests || incomingRequests.length === 0) { %>
          <p class="muted small">No incoming requests.</p>
        <% } else { %>
          <% incomingRequests.forEach((req) => { %>
            <div class="link-row">
              <div>
                <div class="link-email"><%= req.email %></div>
                <div class="muted small">Requested <%= req.created_at ? req.created_at.toISOString().slice(0,10) : '' %></div>
              </div>
              <div class="link-actions">
                <form action="/settings/link/respond" method="POST" class="inline-form">
                  <input type="hidden" name="request_id" value="<%= req.id %>">
                  <input type="hidden" name="action" value="accept">
                  <button type="submit" class="primary">Accept</button>
                </form>
                <form action="/settings/link/respond" method="POST" class="inline-form">
                  <input type="hidden" name="request_id" value="<%= req.id %>">
                  <input type="hidden" name="action" value="decline">
                  <button type="submit" class="ghost danger">Decline</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <div class="data-card stack">
        <div class="table-row header">
          <div>Sent requests</div>
          <div></div>
          <div></div>
        </div>
        <% if (!outgoingRequests || outgoingRequests.length === 0) { %>
          <p class="muted small">No pending requests.</p>
        <% } else { %>
          <% outgoingRequests.forEach((req) => { %>
            <div class="link-row">
              <div>
                <div class="link-email"><%= req.email %></div>
                <div class="muted small">Sent <%= req.created_at ? req.created_at.toISOString().slice(0,10) : '' %></div>
              </div>
              <div class="link-actions">
                <form action="/settings/link/remove" method="POST" class="inline-form">
                  <input type="hidden" name="link_id" value="<%= req.id %>">
                  <button type="submit" class="ghost danger">Cancel</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <div class="table" style="margin-top: 14px;">
      <div class="table-row header linked-row">
        <div>Linked accounts</div>
        <div></div>
      </div>
      <% if (!acceptedLinks || acceptedLinks.length === 0) { %>
        <div class="table-row">
          <div class="muted">No linked accounts yet.</div>
          <div></div>
          <div></div>
        </div>
      <% } else { %>
        <% acceptedLinks.forEach((link) => { %>
          <div class="table-row linked-row">
            <div class="table-email"><%= link.email %></div>
            <div style="text-align: right;">
              <form action="/settings/link/remove" method="POST" class="inline-form">
                <input type="hidden" name="link_id" value="<%= link.linkId %>">
                <button type="submit" class="ghost danger">Remove</button>
              </form>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </section>

  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Preferences</p>
          <h2>Display &amp; account</h2>
          <p class="muted small">Choose how weights show up and manage your account.</p>
        </div>
      </div>
      <form action="/settings/preferences" method="POST" class="stack compact">
        <div class="field">
          <span>Preferred weight unit</span>
          <div class="pill-group" data-weight-unit>
            <label class="pill <%= (user.weight_unit || 'lb') === 'lb' ? 'active' : '' %>">
              <input type="radio" name="weight_unit" value="lb" <%= (user.weight_unit || 'lb') === 'lb' ? 'checked' : '' %>> Pounds (lb)
            </label>
            <label class="pill <%= user.weight_unit === 'kg' ? 'active' : '' %>">
              <input type="radio" name="weight_unit" value="kg" <%= user.weight_unit === 'kg' ? 'checked' : '' %>> Kilograms (kg)
            </label>
          </div>
          <p class="muted small">Affects how weights display across the app.</p>
        </div>
        <button type="submit" class="primary">Save</button>
      </form>
      <div class="data-card stack danger-card spaced-top">
        <p class="muted">Need to delete your account? You can request deletion without logging in.</p>
        <a class="ghost danger full" href="/delete">Open deletion request page</a>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Data</p>
          <h2>Backup &amp; restore</h2>
        </div>
      </div>
      <div class="data-actions">
        <form action="/settings/export" method="GET" class="data-card stack">
          <p class="muted">Download your entries and goal as JSON.</p>
          <button type="submit" class="primary full">Export JSON</button>
        </form>
        <form id="import-form" action="/settings/import" method="POST" enctype="multipart/form-data" class="data-card stack">
          <p class="muted danger-text">Import a saved export (.json). This will delete all current entries and replace them with the file.</p>
          <input class="file-input" type="file" name="import_file" accept="application/json" required>
          <button type="submit" class="primary full">Import JSON</button>
        </form>
      </div>
    </div>
  </section>
  <script>
    (() => {
      const toggle = document.querySelector('[data-totp-toggle]');
      const body = document.querySelector('[data-totp-body]');
      const importForm = document.getElementById('import-form');
      if (importForm) {
        importForm.addEventListener('submit', (evt) => {
          const ok = confirm('Importing will DELETE all current entries and replace them with the backup file. Continue?');
          if (!ok) {
            evt.preventDefault();
          }
        });
      }

      const unitGroup = document.querySelector('[data-weight-unit]');
      if (unitGroup) {
        unitGroup.addEventListener('change', (evt) => {
          if (evt.target.name !== 'weight_unit') return;
          unitGroup.querySelectorAll('.pill').forEach((pill) => pill.classList.remove('active'));
          const label = evt.target.closest('.pill');
          if (label) label.classList.add('active');
        });
      }

      if (!toggle || !body) return;

      const updateLabel = () => {
        const hidden = body.classList.contains('hidden');
        toggle.textContent = hidden ? 'Show details' : 'Hide details';
        toggle.setAttribute('aria-expanded', String(!hidden));
      };

      toggle.addEventListener('click', () => {
        body.classList.toggle('hidden');
        updateLabel();
      });

      updateLabel();
    })();
  </script>
<%- include('partials/footer') %>
