<%- include('partials/header', { title: 'Settings' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Target</p>
          <h2>Daily goal</h2>
        </div>
        <a href="/dashboard" class="ghost">Back to dashboard</a>
      </div>
      <form action="/goal" method="POST" class="stack">
        <label class="field">
          <span>Goal in kcal</span>
          <input type="number" name="goal" min="0" placeholder="e.g. 2200" value="<%= user.daily_goal || '' %>">
        </label>
        <button type="submit" class="primary">Save goal</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Two-factor</p>
          <h2>Protect your account</h2>
        </div>
      </div>

      <div class="panel-toggle">
        <p class="muted small">Manage authenticator setup and 2FA status.</p>
        <button type="button" class="ghost" data-totp-toggle aria-expanded="false">Show details</button>
      </div>

      <div class="stack hidden" data-totp-body>
        <% if (user.totp_enabled) { %>
          <div class="alert success">2FA is enabled for <%= user.email %>.</div>
          <p class="muted">Use your authenticator app to generate codes. To disable, confirm with a current code.</p>
          <form action="/2fa/disable" method="POST" class="stack compact">
            <label class="field">
              <span>Current 2FA code</span>
              <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
            </label>
            <button type="submit" class="ghost danger">Disable 2FA</button>
          </form>
        <% } else if (hasTempSecret) { %>
          <div class="alert">Scan the QR code or copy the setup link, then confirm with a 6-digit code.</div>
          <div class="grid two">
            <div class="qr">
              <% if (qrDataUrl) { %>
                <img src="<%= qrDataUrl %>" alt="2FA QR code">
              <% } %>
              <% if (otpauthUrl) { %>
                <code class="muted break"><%= otpauthUrl %></code>
              <% } %>
            </div>
            <form action="/2fa/enable" method="POST" class="stack compact">
              <label class="field">
                <span>6-digit code</span>
                <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
              </label>
              <button type="submit" class="primary">Activate 2FA</button>
            </form>
          </div>
        <% } else { %>
          <div class="alert">Add an authenticator app (like 1Password, Authy, Google Authenticator) for stronger protection.</div>
          <a class="primary" href="/2fa/setup">Start setup</a>
        <% } %>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Data</p>
        <h2>Backup &amp; restore</h2>
      </div>
    </div>
    <div class="data-actions">
      <form action="/settings/export" method="GET" class="data-card stack">
        <p class="muted">Download your entries and goal as JSON.</p>
        <button type="submit" class="primary full">Export JSON</button>
      </form>
      <form id="import-form" action="/settings/import" method="POST" enctype="multipart/form-data" class="data-card stack">
        <p class="muted danger-text">Import a saved export (.json). This will delete all current entries and replace them with the file.</p>
        <input class="file-input" type="file" name="import_file" accept="application/json" required>
        <button type="submit" class="primary full">Import JSON</button>
      </form>
    </div>
  </section>
  <script>
    (() => {
      const toggle = document.querySelector('[data-totp-toggle]');
      const body = document.querySelector('[data-totp-body]');
      const importForm = document.getElementById('import-form');
      if (importForm) {
        importForm.addEventListener('submit', (evt) => {
          const ok = confirm('Importing will DELETE all current entries and replace them with the backup file. Continue?');
          if (!ok) {
            evt.preventDefault();
          }
        });
      }

      if (!toggle || !body) return;

      const updateLabel = () => {
        const hidden = body.classList.contains('hidden');
        toggle.textContent = hidden ? 'Show details' : 'Hide details';
        toggle.setAttribute('aria-expanded', String(!hidden));
      };

      toggle.addEventListener('click', () => {
        body.classList.toggle('hidden');
        updateLabel();
      });

      updateLabel();
    })();
  </script>
<%- include('partials/footer') %>
