<%- include('partials/header', { title: 'Dashboard' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Today</p>
          <h2>Calorie balance</h2>
        </div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Goal</div>
          <div class="stat-value"><%= user.daily_goal ? `${user.daily_goal} kcal` : 'Not set' %></div>
        </div>
        <div class="stat">
          <div class="stat-label">Logged today</div>
          <div class="stat-value"><%= todayTotal %> kcal</div>
        </div>
        <div class="stat">
          <div class="stat-label">Status</div>
          <% if (!user.daily_goal) { %>
            <div class="chip">Set a goal</div>
          <% } else if (goalStatus === 'under') { %>
            <div class="chip success">Under goal</div>
            <div class="muted small">Room left: <%= goalDelta %> kcal</div>
          <% } else { %>
            <div class="chip danger">Over goal</div>
            <div class="muted small">Over by <%= goalDelta %> kcal</div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Log</p>
        <h2>New entry</h2>
      </div>
    </div>
    <form action="/entries" method="POST" class="stack horizontal" data-log-form>
      <label class="field">
        <span>Calories</span>
        <input
          type="tel"
          name="amount"
          inputmode="tel"
          autocomplete="off"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          placeholder="e.g. 250, -200">
      </label>
      <label class="field">
        <span>Label</span>
        <input type="text" name="entry_name" maxlength="120" placeholder="Optional">
      </label>
      <label class="field">
        <span>Date</span>
        <input type="date" name="entry_date" data-date-input data-weight-date value="<%= selectedDate %>">
      </label>
      <label class="field">
        <span>Weight</span>
        <input type="text" name="weight" inputmode="decimal" autocomplete="off" data-weight-input class="weight-input" placeholder="Optional">
      </label>
      <button type="submit" class="primary">Record</button>
    </form>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Recent</p>
        <h2>Timeline</h2>
        <p class="muted small">Showing <%= range.start %> to <%= range.end %> 路 <%= range.days %> days</p>
      </div>
      <div class="timeframe">
        <div class="range-controls">
          <button type="button" class="ghost small range-toggle" data-range-toggle>More options</button>
          <form method="GET" class="range-custom <%= range.preset === null ? '' : 'hidden' %>" data-range-custom>
            <input type="hidden" name="day" value="<%= selectedDate %>">
            <div class="range-chips nested">
              <% [7, 14, 30, 60, 90, 120, 180].forEach((days) => { %>
                <button type="submit" name="range" value="<%= days %>" class="range-chip narrow <%= range.preset === days ? 'active' : '' %>"><%= days %>d</button>
              <% }) %>
            </div>
            <label class="field compact">
              <span>From</span>
              <input type="date" name="start" value="<%= range.start %>">
            </label>
            <label class="field compact">
              <span>To</span>
              <input type="date" name="end" value="<%= range.end %>">
            </label>
            <button class="ghost" type="submit">Apply</button>
          </form>
        </div>
      </div>
    </div>
    <div class="share-grid">
      <% const todayStr = new Date().toISOString().slice(0,10); %>
      <% sharedViews.forEach((view) => { %>
        <div
          class="share-card"
          data-share-block
          data-user-id="<%= view.userId %>"
          data-user-label="<%= view.label %>"
          data-user-email="<%= view.email %>"
          data-link-id="<%= view.linkId || '' %>"
          data-is-self="<%= view.isSelf %>"
        >
          <div class="share-card-head">
            <div>
              <p class="eyebrow"><%= view.isSelf ? 'You' : 'Shared' %></p>
              <h3 class="share-title">
                <% if (view.isSelf) { %>
                  <%= view.label %>
                <% } else { %>
                  <button
                    type="button"
                    class="share-title-btn"
                    data-edit-share-label
                    data-link-id="<%= view.linkId %>"
                  ><%= view.label %></button>
                <% } %>
              </h3>
              <p class="muted small"><%= view.isSelf ? 'Your log' : 'View only' %></p>
            </div>
            <div class="chip <%= view.dailyGoal ? '' : 'muted' %>">
              <%= view.dailyGoal ? `${view.dailyGoal} kcal goal` : 'Goal not set' %>
            </div>
          </div>
          <div class="dot-row">
            <% view.dailyStats.forEach((day) => { %>
              <div
                class="dot-wrap"
                role="button"
                tabindex="0"
                data-day-dot
                data-user-id="<%= view.userId %>"
                data-user-label="<%= view.label %>"
                data-link-id="<%= view.linkId || '' %>"
                data-is-self="<%= view.isSelf %>"
                data-date="<%= day.date %>"
                data-tip="<%= day.date %>"
              >
                <% if (!view.dailyGoal) { %>
                  <div class="dot muted <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'zero') { %>
                  <div class="dot zero <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'under') { %>
                  <div class="dot success <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'over_threshold') { %>
                  <div class="dot danger <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else { %>
                  <div class="dot warn <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } %>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
    <div class="day-selected" data-day-selected>Showing <%= selectedDate === new Date().toISOString().slice(0,10) ? 'today' : selectedDate %> 路 You</div>
    <% const weightTime = weightEntry && (weightEntry.updated_at || weightEntry.created_at) ? (weightEntry.updated_at || weightEntry.created_at).toISOString().slice(11,16) : ''; %>
    <div class="log-list">
      <div class="weight-slot" data-weight-slot>
        <div class="entry-row weight-row <%= weightEntry ? '' : 'is-empty' %>" data-weight-row>
          <div>
            <button type="button" class="edit-trigger entry-name is-locked" data-locked="true">Weight</button>
          </div>
        <div class="entry-actions">
            <div class="entry-amount-wrap">
              <button type="button" class="edit-trigger entry-amount weight <%= weightEntry ? '' : 'muted' %>" data-weight-value><%= weightEntry ? `${weightEntry.weight}` : 'Add weight' %></button>
            </div>
          <span class="entry-time muted small" data-weight-time><%= weightEntry ? weightTime : '' %></span>
          <form class="inline-form delete-placeholder" aria-hidden="true">
            <button type="button" class="ghost danger small placeholder-delete" tabindex="-1">Delete</button>
          </form>
        </div>
      </div>
    </div>
      <div class="entry-list <%= (!recentEntries || recentEntries.length === 0) ? 'hidden' : '' %>" data-entry-list>
        <% if (recentEntries && recentEntries.length > 0) { %>
          <% recentEntries.forEach((entry) => { %>
            <div class="entry-row" data-entry-row data-entry-id="<%= entry.id %>">
              <div>
                <button type="button" class="edit-trigger entry-name" data-edit-name><%= entry.entry_name || 'Untitled' %></button>
              </div>
              <div class="entry-actions">
                <div class="entry-amount-wrap">
                  <button type="button" class="edit-trigger entry-amount <%= entry.amount >= 0 ? 'pos' : 'neg' %>" data-edit-amount><%= entry.amount %> kcal</button>
                </div>
                <span class="entry-time muted small" data-entry-time><%= entry.created_at ? entry.created_at.toISOString().slice(11,16) : '' %></span>
                <form action="/entries/<%= entry.id %>/delete" method="POST" class="inline-form" data-delete-form>
                  <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="<%= entry.id %>">Delete</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="muted <%= (!recentEntries || recentEntries.length === 0) ? '' : 'hidden' %>" data-entry-empty>No entries yet.</div>
    </div>
  </section>

  <script>
    (() => {
      const dots = Array.from(document.querySelectorAll('[data-day-dot]'));
      const entryList = document.querySelector('[data-entry-list]');
      const emptyState = document.querySelector('[data-entry-empty]');
      const daySelected = document.querySelector('[data-day-selected]');
      const selfUserId = '<%= user.id %>';
      const todayStr = new Date().toISOString().slice(0, 10);
      let currentDate = '<%= selectedDate %>';
      let currentUserId = selfUserId;
      let currentLabel = <%- JSON.stringify(sharedViews && sharedViews.length ? sharedViews[0].label : 'You') %>;
      let currentCanEdit = true;
      let activeInlineEdit = null;
      let activeShareLabelEdit = null;
      let entryEventSource = null;
      let pollTimer = null;
      const initialEntries = <%- JSON.stringify(recentEntries.map((entry) => ({
        id: entry.id,
        date: entry.entry_date ? entry.entry_date.toISOString().slice(0, 10) : selectedDate,
        time: entry.created_at ? entry.created_at.toISOString().slice(11, 16) : '',
        amount: entry.amount,
        name: entry.entry_name || null,
      }))) %>;
      const weightInput = document.querySelector('[data-weight-input]');
      const weightDateInput = document.querySelector('[data-weight-date]');
      const weightSlot = document.querySelector('[data-weight-slot]');
      const weightRow = document.querySelector('[data-weight-row]');
      const weightValueBtn = document.querySelector('[data-weight-value]');
      const weightTime = document.querySelector('[data-weight-time]');
      const rangeToggle = document.querySelector('[data-range-toggle]');
      const rangeCustom = document.querySelector('[data-range-custom]');
      const initialWeight = <%- JSON.stringify(weightEntry || null) %>;
      const weightCache = new Map();
      if (initialWeight) {
        weightCache.set(`${selfUserId}:${initialWeight.date}`, initialWeight);
      }

      const escapeHtml = (value) =>
        String(value || '').replace(
          /[&<>"']/g,
          (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])
        );

      const teardownShareLabelEditor = () => {
        if (activeShareLabelEdit) {
          const { form, trigger, card } = activeShareLabelEdit;
          form.remove();
          trigger.classList.remove('hidden');
          card.classList.remove('is-editing');
          activeShareLabelEdit = null;
        }
      };

      const saveShareLabel = async (linkId, value) => {
        const res = await fetch(`/links/${linkId}/label`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
          body: JSON.stringify({ label: value }),
        });
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        if (!data.ok) throw new Error('Update failed');
        return data.label || '';
      };

      const openShareLabelEditor = (btn) => {
        const shareCard = btn.closest('[data-share-block]');
        const linkId = btn.dataset.linkId;
        if (!shareCard || !linkId) return;
        if (shareCard.querySelector('[data-inline-editing]')) return;

        if (activeInlineEdit) {
          const { form, btn: openBtn } = activeInlineEdit;
          form.remove();
          openBtn.classList.remove('hidden');
          activeInlineEdit = null;
        }
        teardownShareLabelEditor();
        teardownWeightEditor();

        const form = document.createElement('form');
        form.className = 'inline-edit';
        form.dataset.inlineEditing = 'true';

        const input = document.createElement('input');
        input.type = 'text';
        input.autocomplete = 'off';
        input.maxLength = 120;
        input.className = 'inline-edit-input';
        input.placeholder = shareCard.dataset.userEmail || 'Label';
        input.value = btn.textContent.trim();

        const spinner = document.createElement('span');
        spinner.className = 'inline-edit-spinner hidden';

        form.append(input, spinner);
        btn.insertAdjacentElement('afterend', form);
        btn.classList.add('hidden');
        shareCard.classList.add('is-editing');

        const finish = () => {
          form.remove();
          btn.classList.remove('hidden');
          shareCard.classList.remove('is-editing');
          if (activeShareLabelEdit && activeShareLabelEdit.form === form) {
            activeShareLabelEdit = null;
          }
        };

        let saving = false;
        const handleSave = async () => {
          if (saving) return;
          saving = true;
          form.classList.add('is-saving');
          spinner.classList.remove('hidden');
          try {
            const updatedLabel = await saveShareLabel(linkId, input.value.trim());
            applyShareLabel(shareCard, updatedLabel);
            finish();
          } catch (err) {
            console.error('Share label update failed', err);
            saving = false;
            form.classList.remove('is-saving');
            spinner.classList.add('hidden');
          }
        };

        form.addEventListener('submit', (evt) => {
          evt.preventDefault();
          handleSave();
        });

        input.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') {
            finish();
          } else if (evt.key === 'Enter') {
            evt.preventDefault();
            handleSave();
          }
        });

        input.addEventListener('blur', handleSave);

        activeShareLabelEdit = { form, trigger: btn, card: shareCard };
        input.focus();
        input.select();
      };

      if (rangeToggle && rangeCustom) {
        rangeToggle.addEventListener('click', () => {
          const showing = rangeCustom.classList.toggle('hidden') === false;
          rangeToggle.textContent = showing ? 'Hide options' : 'More options';
        });
      }

      const renderEntries = (entries, canEdit) => {
        if (!entryList) return;
        entryList.innerHTML = '';
        if (!entries || entries.length === 0) {
          entryList.classList.add('hidden');
          if (emptyState) {
            emptyState.textContent = canEdit ? 'No entries yet.' : 'No shared entries yet.';
            emptyState.classList.remove('hidden');
          }
          return;
        }

        if (emptyState) emptyState.classList.add('hidden');
        entryList.classList.remove('hidden');
        entryList.innerHTML = entries
          .map((entry) => {
            const safeName = escapeHtml(entry.name || 'Untitled');
            if (!canEdit) {
              return `
              <div class="entry-row view-only" data-entry-row data-entry-id="${entry.id}">
                <div>
                  <button type="button" class="edit-trigger entry-name is-locked" data-locked="true">${safeName}</button>
                </div>
                <div class="entry-actions">
                  <div class="entry-amount-wrap">
                    <button type="button" class="edit-trigger entry-amount ${entry.amount >= 0 ? 'pos' : 'neg'} is-locked" data-locked="true">${entry.amount} kcal</button>
                  </div>
                  <span class="entry-time muted small">${entry.time || ''}</span>
                  <form class="inline-form delete-placeholder" aria-hidden="true">
                    <button type="button" class="ghost danger small placeholder-delete" tabindex="-1">Delete</button>
                  </form>
                </div>
              </div>
            `;
            }
            return `
            <div class="entry-row" data-entry-row data-entry-id="${entry.id}">
              <div>
                <button type="button" class="edit-trigger entry-name" data-edit-name>${safeName}</button>
              </div>
              <div class="entry-actions">
                <div class="entry-amount-wrap">
                  <button type="button" class="edit-trigger entry-amount ${entry.amount >= 0 ? 'pos' : 'neg'}" data-edit-amount>${entry.amount} kcal</button>
                </div>
                <span class="entry-time muted small" data-entry-time>${entry.time || ''}</span>
                <form action="/entries/${entry.id}/delete" method="POST" class="inline-form" data-delete-form>
                  <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="${entry.id}">Delete</button>
                </form>
              </div>
            </div>
          `;
          })
          .join('');
      };

      const renderWeight = (entry, date, userId, label, canEdit) => {
        if (weightDateInput) {
          weightDateInput.value = date;
        }
        if (weightInput) {
          const hasEntry = Boolean(entry);
          weightInput.value = '';
          weightInput.disabled = hasEntry || !canEdit;
          weightInput.classList.toggle('is-disabled', hasEntry || !canEdit);
          weightInput.placeholder = hasEntry ? 'Logged for day' : 'Optional';
        }
        if (weightRow && weightValueBtn) {
          const labelBtn = weightRow.querySelector('.entry-name');
          if (labelBtn) {
            labelBtn.textContent = 'Weight';
            labelBtn.dataset.locked = 'true';
            labelBtn.classList.add('is-locked');
          }
          const timeStr =
            entry && (entry.updated_at || entry.created_at)
              ? new Date(entry.updated_at || entry.created_at).toISOString().slice(11, 16)
              : '';
          weightRow.classList.toggle('is-empty', !entry);
          weightValueBtn.textContent = entry ? `${entry.weight}` : 'Add weight';
          weightValueBtn.classList.toggle('muted', !entry);
          weightValueBtn.classList.toggle('pos', Boolean(entry));
          weightRow.classList.toggle('view-only', !canEdit);
          weightValueBtn.dataset.locked = String(!canEdit);
          weightValueBtn.classList.toggle('is-locked', !canEdit);
          if (weightTime) {
            weightTime.textContent = entry ? timeStr : '';
          }
        }
      };

      const applyShareLabel = (shareCard, rawLabel) => {
        if (!shareCard) return;
        const fallback = shareCard.dataset.userEmail || 'Shared';
        const displayLabel = rawLabel && rawLabel.trim() ? rawLabel.trim() : fallback;
        shareCard.dataset.userLabel = displayLabel;
        const dotsInCard = shareCard.querySelectorAll('[data-day-dot]');
        dotsInCard.forEach((dot) => {
          dot.dataset.userLabel = displayLabel;
        });
        const titleBtn = shareCard.querySelector('[data-edit-share-label]');
        const titleEl = shareCard.querySelector('.share-title');
        if (titleBtn) {
          titleBtn.textContent = displayLabel;
        } else if (titleEl) {
          titleEl.textContent = displayLabel;
        }
        if (String(currentUserId) === String(shareCard.dataset.userId)) {
          currentLabel = displayLabel;
          const labelDate = currentDate === todayStr ? 'today' : currentDate;
          if (daySelected) {
            daySelected.textContent = `Showing ${labelDate} 路 ${currentLabel}`;
          }
          const weightCacheKey = `${currentUserId}:${currentDate}`;
          renderWeight(
            weightCache.get(weightCacheKey) || null,
            currentDate,
            currentUserId,
            currentLabel,
            currentCanEdit
          );
        }
      };

      const loadWeightForDate = async (userId, date, label, canEdit) => {
        if (!weightDateInput || !date) return;
        const cacheKey = `${userId}:${date}`;
        if (weightCache.has(cacheKey)) {
          renderWeight(weightCache.get(cacheKey), date, userId, label, canEdit);
          return;
        }
        try {
          const params = new URLSearchParams({ date });
          if (String(userId) !== String(selfUserId)) {
            params.set('user', userId);
          }
          const res = await fetch(`/weight/day?${params.toString()}`, { headers: { Accept: 'application/json' } });
          if (!res.ok) {
            renderWeight(null, date, userId, label, canEdit);
            return;
          }
          const data = await res.json();
          if (data.ok) {
            const entry = data.entry || null;
            weightCache.set(cacheKey, entry);
            renderWeight(entry, date, userId, label, canEdit);
          }
        } catch (err) {
          renderWeight(null, date, userId, label, canEdit);
        }
      };

      let activeWeightEdit = null;
      const teardownWeightEditor = () => {
        if (activeWeightEdit) {
          const { form, trigger } = activeWeightEdit;
          form.remove();
          if (trigger) trigger.classList.remove('hidden');
          activeWeightEdit = null;
        }
      };

      const saveWeight = async (value) => {
        const payload = { weight: value, entry_date: currentDate };
        const res = await fetch('/weight/upsert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error('Request failed');
        }
        const data = await res.json();
        if (!data.ok || !data.entry) {
          throw new Error('Save failed');
        }
        weightCache.set(`${selfUserId}:${data.entry.date}`, data.entry);
        renderWeight(data.entry, data.entry.date, selfUserId, true);
      };

      const openWeightEditor = (triggerEl) => {
        if (!weightSlot) return;
        const row = triggerEl?.closest('[data-weight-row]') || weightRow;
        if (!row) return;
        if (row.querySelector('[data-inline-editing]')) return;

        // Close any other inline edit (entries or weight) for consistency
        if (activeInlineEdit) {
          const { form, btn: openBtn } = activeInlineEdit;
          form.remove();
          if (openBtn) openBtn.classList.remove('hidden');
          activeInlineEdit = null;
        }

        const btnTarget = triggerEl || weightValueBtn;
        if (!btnTarget) return;
        if (!currentCanEdit) return;
        const form = document.createElement('form');
        form.className = 'inline-edit inline-edit--amount';
        form.dataset.inlineEditing = 'true';

        const input = document.createElement('input');
        input.type = 'tel';
        input.inputMode = 'tel';
        input.autocomplete = 'off';
        input.className = 'inline-edit-input inline-edit-input--amount';
        input.placeholder = 'e.g. 72.4';
        const currentWeight = weightCache.get(currentDate)?.weight;
        input.value = currentWeight ? currentWeight : '';

        const spinner = document.createElement('span');
        spinner.className = 'inline-edit-spinner hidden';

        form.append(input, spinner);
        btnTarget.insertAdjacentElement('afterend', form);

        const finish = () => {
          form.remove();
          btnTarget.classList.remove('hidden');
          row.classList.remove('is-editing');
          activeInlineEdit = null;
          activeWeightEdit = null;
        };

        let saving = false;
        const handleSave = async () => {
          if (saving) return;
          const value = input.value.trim();
          if (!value) {
            finish();
            return;
          }
          saving = true;
          spinner.classList.remove('hidden');
          form.classList.add('is-saving');
          row.classList.add('is-editing');
          try {
            await saveWeight(value);
            finish();
          } catch (err) {
            console.error('Weight save failed', err);
            saving = false;
            spinner.classList.add('hidden');
            form.classList.remove('is-saving');
            row.classList.remove('is-editing');
          }
        };

        form.addEventListener('submit', (evt) => {
          evt.preventDefault();
          handleSave();
        });

        input.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') {
            finish();
          } else if (evt.key === 'Enter') {
            evt.preventDefault();
            handleSave();
          }
        });

        input.addEventListener('blur', handleSave);

        btnTarget.classList.add('hidden');
        activeInlineEdit = { form, btn: btnTarget };
        activeWeightEdit = { form, trigger: btnTarget };
        input.focus();
        input.select();
      };

      const setActiveDay = (userId, date, label) => {
        teardownWeightEditor();
        dots.forEach((dot) => {
          const active = dot.dataset.userId === String(userId) && dot.dataset.date === date;
          dot.classList.toggle('active', active);
        });
        if (daySelected) {
          const labelDate = date === todayStr ? 'today' : date;
          daySelected.textContent = `Showing ${labelDate} 路 ${label}`;
        }
        if (weightDateInput) {
          weightDateInput.value = date;
        }
        loadWeightForDate(userId, date, label, userId === selfUserId);
      };

      const loadEntries = async (userId, date, canEdit) => {
        const params = new URLSearchParams({ date });
        if (String(userId) !== String(selfUserId)) {
          params.set('user', userId);
        }
        try {
          const res = await fetch(`/entries/day?${params.toString()}`, {
            headers: { Accept: 'application/json' },
          });
          if (!res.ok) return;
          const data = await res.json();
          if (data.ok) {
            renderEntries(data.entries, canEdit);
          }
        } catch (err) {
          console.error('Failed to load entries', err);
        }
      };

      const refreshCurrentEntries = () => {
        loadEntries(currentUserId, currentDate, currentCanEdit);
      };

      const stopPolling = () => {
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      };

      const startPolling = () => {
        if (pollTimer) return;
        pollTimer = setInterval(refreshCurrentEntries, 15000);
      };

      const handleEntryEvent = (payload) => {
        if (!payload || payload.sourceUserId === undefined) return;
        if (String(payload.sourceUserId) === String(currentUserId)) {
          refreshCurrentEntries();
        }
      };

      const startEntryEvents = () => {
        if (!window.EventSource) {
          startPolling();
          return;
        }
        if (entryEventSource) return;
        const source = new EventSource('/events/entries');
        entryEventSource = source;
        source.addEventListener('entry-change', (evt) => {
          try {
            const data = JSON.parse(evt.data || '{}');
            handleEntryEvent(data);
          } catch (err) {
            console.error('Failed to parse entry event', err);
          }
        });
        source.onerror = () => {
          source.close();
          entryEventSource = null;
          startPolling();
          setTimeout(startEntryEvents, 2000);
        };
      };

      document.addEventListener('submit', async (evt) => {
        if (!currentCanEdit) return;
        const form = evt.target.closest('[data-delete-form]');
        if (!form) return;
        evt.preventDefault();
        const btn = form.querySelector('[data-delete-entry]');
        const entryId = btn?.dataset.entryId;
        if (!entryId) return;
        try {
          const res = await fetch(`/entries/${entryId}/delete`, {
            method: 'POST',
            headers: { Accept: 'application/json' },
          });
          if (res.ok) {
            loadEntries(currentUserId, currentDate, currentCanEdit);
          }
        } catch (err) {
          console.error('Delete failed', err);
        }
      });

      const updateEntry = async (entryId, payload) => {
        const res = await fetch(`/entries/${entryId}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error('Request failed');
        }
        const data = await res.json();
        if (!data.ok) {
          throw new Error('Update failed');
        }
        return data.entry;
      };

      const applyEntryUpdate = (row, entry) => {
        const nameBtn = row.querySelector('[data-edit-name]');
        const amountBtn = row.querySelector('[data-edit-amount]');
        const timeEl = row.querySelector('[data-entry-time]');
        if (nameBtn) {
          nameBtn.textContent = entry.name || 'Untitled';
        }
        if (amountBtn) {
          amountBtn.textContent = `${entry.amount} kcal`;
          amountBtn.classList.toggle('pos', entry.amount >= 0);
          amountBtn.classList.toggle('neg', entry.amount < 0);
        }
        if (timeEl && entry.time) {
          timeEl.textContent = entry.time;
        }
      };

      const createInlineEditor = ({ btn, type, placeholder }) => {
        const row = btn.closest('[data-entry-id]');
        const entryId = row?.dataset.entryId;
        if (!row || !entryId) return null;
        if (row.querySelector('[data-inline-editing]')) {
          return null;
        }
        if (activeInlineEdit) {
          const { form, btn: openBtn } = activeInlineEdit;
          form.remove();
          openBtn.classList.remove('hidden');
          activeInlineEdit = null;
        }

        const currentValue =
          type === 'amount'
            ? btn.textContent.replace('kcal', '').trim()
            : btn.textContent.trim() === 'Untitled'
            ? ''
            : btn.textContent.trim();

        btn.classList.add('hidden');

        const form = document.createElement('form');
        form.className = `inline-edit${type === 'amount' ? ' inline-edit--amount' : ''}`;
        form.dataset.inlineEditing = 'true';

        const input = document.createElement('input');
        input.type = type === 'amount' ? 'tel' : 'text';
        if (type === 'amount') input.inputMode = 'tel';
        input.autocomplete = 'off';
        input.className = `inline-edit-input${type === 'amount' ? ' inline-edit-input--amount' : ''}`;
        input.placeholder = placeholder;
        input.value = currentValue;

        const spinner = document.createElement('span');
        spinner.className = 'inline-edit-spinner hidden';

        form.append(input, spinner);

        const tearDown = () => {
          form.remove();
          btn.classList.remove('hidden');
          row.classList.remove('is-editing');
          if (activeInlineEdit && activeInlineEdit.form === form) {
            activeInlineEdit = null;
          }
          form.classList.remove('is-saving');
          spinner.classList.add('hidden');
        };

        let submitting = false;
        const handleSubmit = async () => {
          if (submitting) return;
          const value = input.value.trim();
          if (!value && type === 'amount') {
            tearDown();
            return;
          }
          submitting = true;
          form.classList.add('is-saving');
          spinner.classList.remove('hidden');
          row.classList.add('is-editing');
          try {
            const updated = await updateEntry(entryId, type === 'amount' ? { amount: value } : { name: value });
            applyEntryUpdate(row, updated);
            tearDown();
          } catch (err) {
            console.error('Update failed', err);
            submitting = false;
            form.classList.remove('is-saving');
            spinner.classList.add('hidden');
          }
        };

        form.addEventListener('submit', (evt) => {
          evt.preventDefault();
          handleSubmit();
        });

        input.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') {
            tearDown();
          } else if (evt.key === 'Enter') {
            evt.preventDefault();
            handleSubmit();
          }
        });

        input.addEventListener('blur', () => {
          handleSubmit();
        });

        btn.insertAdjacentElement('afterend', form);
        input.focus();
        input.select();
        activeInlineEdit = { form, btn };
        return form;
      };

      document.addEventListener('click', (evt) => {
        const shareLabelBtn = evt.target.closest('[data-edit-share-label]');
        if (shareLabelBtn) {
          openShareLabelEditor(shareLabelBtn);
          return;
        }
        if (!currentCanEdit) return;
        const nameBtn = evt.target.closest('[data-edit-name]');
        if (nameBtn) {
          createInlineEditor({
            btn: nameBtn,
            type: 'name',
            placeholder: 'e.g. Breakfast',
          });
          return;
        }
        const amountBtn = evt.target.closest('[data-edit-amount]');
        if (amountBtn) {
          createInlineEditor({
            btn: amountBtn,
            type: 'amount',
            placeholder: 'e.g. 250, -120',
          });
        }
        const weightTrigger = evt.target.closest('[data-weight-value]');
        if (weightTrigger) {
          openWeightEditor(weightTrigger);
        }
      });

      dots.forEach((dot) => {
        const handle = () => {
          const date = dot.dataset.date;
          const userId = dot.dataset.userId;
          if (!date || !userId) return;
          currentDate = date;
          currentUserId = userId;
          currentLabel = dot.dataset.userLabel || 'Shared';
          currentCanEdit = dot.dataset.isSelf === 'true';
          setActiveDay(userId, date, currentLabel);
          loadEntries(userId, date, currentCanEdit);
        };
        dot.addEventListener('click', handle);
        dot.addEventListener('keypress', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            handle();
          }
        });
      });

      renderEntries(initialEntries, true);
      setActiveDay(currentUserId, currentDate, currentLabel);
      startEntryEvents();

      const initialDay = todayStr;
      setInterval(() => {
        const today = new Date().toISOString().slice(0, 10);
        if (today !== initialDay) {
          window.location.reload();
        }
      }, 60_000);
    })();
  </script>
<%- include('partials/footer') %>
