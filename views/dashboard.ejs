<%- include('partials/header', { title: 'Dashboard' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Today</p>
          <h2>Calorie balance</h2>
        </div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Goal</div>
          <div class="stat-value"><%= user.daily_goal ? `${user.daily_goal} kcal` : 'Not set' %></div>
        </div>
        <div class="stat">
          <div class="stat-label">Logged today</div>
          <div class="stat-value"><%= todayTotal %> kcal</div>
        </div>
        <div class="stat">
          <div class="stat-label">Status</div>
          <% if (!user.daily_goal) { %>
            <div class="chip">Set a goal</div>
          <% } else if (goalStatus === 'under') { %>
            <div class="chip success">Under goal</div>
            <div class="muted small">Room left: <%= goalDelta %> kcal</div>
          <% } else { %>
            <div class="chip danger">Over goal</div>
            <div class="muted small">Over by <%= goalDelta %> kcal</div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Log</p>
        <h2>Add calories</h2>
      </div>
    </div>
    <form action="/entries" method="POST" class="stack horizontal">
      <label class="field">
        <span>Amount</span>
        <input
          type="tel"
          name="amount"
          inputmode="tel"
          autocomplete="off"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          required
          placeholder="e.g. 250, -200, (3*4)/6">
      </label>
      <label class="field">
        <span>Name (optional)</span>
        <input type="text" name="entry_name" maxlength="120" placeholder="e.g. Breakfast, Run, Snack">
      </label>
      <label class="field">
        <span>Date</span>
        <input type="date" name="entry_date" value="<%= new Date().toISOString().slice(0,10) %>">
      </label>
      <button type="submit" class="primary">Record</button>
    </form>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Recent</p>
        <h2>Last 14 days</h2>
      </div>
    </div>
    <div class="share-grid">
      <% const todayStr = new Date().toISOString().slice(0,10); %>
      <% sharedViews.forEach((view) => { %>
        <div class="share-card" data-share-block data-user-id="<%= view.userId %>" data-user-label="<%= view.label %>" data-is-self="<%= view.isSelf %>">
          <div class="share-card-head">
            <div>
              <p class="eyebrow"><%= view.isSelf ? 'You' : 'Shared' %></p>
              <h3 class="share-title"><%= view.label %></h3>
              <p class="muted small"><%= view.isSelf ? 'Your log' : 'View only' %></p>
            </div>
            <div class="chip <%= view.dailyGoal ? '' : 'muted' %>">
              <%= view.dailyGoal ? `${view.dailyGoal} kcal goal` : 'Goal not set' %>
            </div>
          </div>
          <div class="dot-row">
            <% view.dailyStats.forEach((day) => { %>
              <div
                class="dot-wrap"
                role="button"
                tabindex="0"
                data-day-dot
                data-user-id="<%= view.userId %>"
                data-user-label="<%= view.label %>"
                data-is-self="<%= view.isSelf %>"
                data-date="<%= day.date %>"
                data-tip="<%= day.date %>"
              >
                <% if (!view.dailyGoal) { %>
                  <div class="dot muted <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'zero') { %>
                  <div class="dot zero <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'under') { %>
                  <div class="dot success <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else if (day.status === 'over_threshold') { %>
                  <div class="dot danger <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } else { %>
                  <div class="dot warn <%= day.date === todayStr ? 'today' : '' %>"></div>
                <% } %>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
    <div class="day-selected" data-day-selected>Showing <%= selectedDate === new Date().toISOString().slice(0,10) ? 'today' : selectedDate %> · You</div>
    <div class="entry-list <%= (!recentEntries || recentEntries.length === 0) ? 'hidden' : '' %>" data-entry-list>
      <% if (recentEntries && recentEntries.length > 0) { %>
        <% recentEntries.forEach((entry) => { %>
          <div class="entry-row" data-entry-row data-entry-id="<%= entry.id %>">
            <div>
              <button type="button" class="edit-trigger entry-name" data-edit-name><%= entry.entry_name || 'Untitled' %></button>
            </div>
            <div class="entry-actions">
              <div class="entry-amount-wrap">
                <button type="button" class="edit-trigger entry-amount <%= entry.amount >= 0 ? 'pos' : 'neg' %>" data-edit-amount><%= entry.amount %> kcal</button>
              </div>
              <span class="entry-time muted small" data-entry-time><%= entry.created_at ? entry.created_at.toISOString().slice(11,16) : '' %></span>
              <form action="/entries/<%= entry.id %>/delete" method="POST" class="inline-form" data-delete-form>
                <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="<%= entry.id %>">Delete</button>
              </form>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
    <div class="muted <%= (!recentEntries || recentEntries.length === 0) ? '' : 'hidden' %>" data-entry-empty>No entries yet.</div>
  </section>

  <script>
    (() => {
      const dots = Array.from(document.querySelectorAll('[data-day-dot]'));
      const entryList = document.querySelector('[data-entry-list]');
      const emptyState = document.querySelector('[data-entry-empty]');
      const daySelected = document.querySelector('[data-day-selected]');
      const selfUserId = '<%= user.id %>';
      const todayStr = new Date().toISOString().slice(0, 10);
      let currentDate = '<%= selectedDate %>';
      let currentUserId = selfUserId;
      let currentLabel = 'You';
      let currentCanEdit = true;
      let activeInlineEdit = null;
      let entryEventSource = null;
      let pollTimer = null;
      const initialEntries = <%- JSON.stringify(recentEntries.map((entry) => ({
        id: entry.id,
        date: entry.entry_date ? entry.entry_date.toISOString().slice(0, 10) : selectedDate,
        time: entry.created_at ? entry.created_at.toISOString().slice(11, 16) : '',
        amount: entry.amount,
        name: entry.entry_name || null,
      }))) %>;

      const escapeHtml = (value) =>
        String(value || '').replace(
          /[&<>"']/g,
          (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])
        );

      const renderEntries = (entries, canEdit) => {
        if (!entryList) return;
        entryList.innerHTML = '';
        if (!entries || entries.length === 0) {
          entryList.classList.add('hidden');
          if (emptyState) {
            emptyState.textContent = canEdit ? 'No entries yet.' : 'No shared entries yet.';
            emptyState.classList.remove('hidden');
          }
          return;
        }

        if (emptyState) emptyState.classList.add('hidden');
        entryList.classList.remove('hidden');
        entryList.innerHTML = entries
          .map((entry) => {
            const safeName = escapeHtml(entry.name || 'Untitled');
            if (!canEdit) {
              return `
              <div class="entry-row view-only">
                <div class="entry-name">${safeName}</div>
                <div class="entry-actions">
                  <div class="entry-amount-wrap">
                    <span class="entry-amount ${entry.amount >= 0 ? 'pos' : 'neg'}">${entry.amount} kcal</span>
                  </div>
                  <span class="entry-time muted small">${entry.time || ''}</span>
                </div>
              </div>
            `;
            }
            return `
            <div class="entry-row" data-entry-row data-entry-id="${entry.id}">
              <div>
                <button type="button" class="edit-trigger entry-name" data-edit-name>${safeName}</button>
              </div>
              <div class="entry-actions">
                <div class="entry-amount-wrap">
                  <button type="button" class="edit-trigger entry-amount ${entry.amount >= 0 ? 'pos' : 'neg'}" data-edit-amount>${entry.amount} kcal</button>
                </div>
                <span class="entry-time muted small" data-entry-time>${entry.time || ''}</span>
                <form action="/entries/${entry.id}/delete" method="POST" class="inline-form" data-delete-form>
                  <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="${entry.id}">Delete</button>
                </form>
              </div>
            </div>
          `;
          })
          .join('');
      };

      const setActiveDay = (userId, date, label) => {
        dots.forEach((dot) => {
          const active = dot.dataset.userId === String(userId) && dot.dataset.date === date;
          dot.classList.toggle('active', active);
        });
        if (daySelected) {
          const labelDate = date === todayStr ? 'today' : date;
          daySelected.textContent = `Showing ${labelDate} · ${label}`;
        }
      };

      const loadEntries = async (userId, date, canEdit) => {
        const params = new URLSearchParams({ date });
        if (String(userId) !== String(selfUserId)) {
          params.set('user', userId);
        }
        try {
          const res = await fetch(`/entries/day?${params.toString()}`, {
            headers: { Accept: 'application/json' },
          });
          if (!res.ok) return;
          const data = await res.json();
          if (data.ok) {
            renderEntries(data.entries, canEdit);
          }
        } catch (err) {
          console.error('Failed to load entries', err);
        }
      };

      const refreshCurrentEntries = () => {
        loadEntries(currentUserId, currentDate, currentCanEdit);
      };

      const stopPolling = () => {
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      };

      const startPolling = () => {
        if (pollTimer) return;
        pollTimer = setInterval(refreshCurrentEntries, 15000);
      };

      const handleEntryEvent = (payload) => {
        if (!payload || payload.sourceUserId === undefined) return;
        if (String(payload.sourceUserId) === String(currentUserId)) {
          refreshCurrentEntries();
        }
      };

      const startEntryEvents = () => {
        if (!window.EventSource) {
          startPolling();
          return;
        }
        if (entryEventSource) return;
        const source = new EventSource('/events/entries');
        entryEventSource = source;
        source.addEventListener('entry-change', (evt) => {
          try {
            const data = JSON.parse(evt.data || '{}');
            handleEntryEvent(data);
          } catch (err) {
            console.error('Failed to parse entry event', err);
          }
        });
        source.onerror = () => {
          source.close();
          entryEventSource = null;
          startPolling();
          setTimeout(startEntryEvents, 2000);
        };
      };

      document.addEventListener('submit', async (evt) => {
        if (!currentCanEdit) return;
        const form = evt.target.closest('[data-delete-form]');
        if (!form) return;
        evt.preventDefault();
        const btn = form.querySelector('[data-delete-entry]');
        const entryId = btn?.dataset.entryId;
        if (!entryId) return;
        try {
          const res = await fetch(`/entries/${entryId}/delete`, {
            method: 'POST',
            headers: { Accept: 'application/json' },
          });
          if (res.ok) {
            loadEntries(currentUserId, currentDate, currentCanEdit);
          }
        } catch (err) {
          console.error('Delete failed', err);
        }
      });

      const updateEntry = async (entryId, payload) => {
        const res = await fetch(`/entries/${entryId}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error('Request failed');
        }
        const data = await res.json();
        if (!data.ok) {
          throw new Error('Update failed');
        }
        return data.entry;
      };

      const applyEntryUpdate = (row, entry) => {
        const nameBtn = row.querySelector('[data-edit-name]');
        const amountBtn = row.querySelector('[data-edit-amount]');
        const timeEl = row.querySelector('[data-entry-time]');
        if (nameBtn) {
          nameBtn.textContent = entry.name || 'Untitled';
        }
        if (amountBtn) {
          amountBtn.textContent = `${entry.amount} kcal`;
          amountBtn.classList.toggle('pos', entry.amount >= 0);
          amountBtn.classList.toggle('neg', entry.amount < 0);
        }
        if (timeEl && entry.time) {
          timeEl.textContent = entry.time;
        }
      };

      const createInlineEditor = ({ btn, type, placeholder }) => {
        const row = btn.closest('[data-entry-id]');
        const entryId = row?.dataset.entryId;
        if (!row || !entryId) return null;
        if (row.querySelector('[data-inline-editing]')) {
          return null;
        }
        if (activeInlineEdit) {
          const { form, btn: openBtn } = activeInlineEdit;
          form.remove();
          openBtn.classList.remove('hidden');
          activeInlineEdit = null;
        }

        const currentValue =
          type === 'amount'
            ? btn.textContent.replace('kcal', '').trim()
            : btn.textContent.trim() === 'Untitled'
            ? ''
            : btn.textContent.trim();

        btn.classList.add('hidden');

        const form = document.createElement('form');
        form.className = 'inline-edit';
        form.dataset.inlineEditing = 'true';

        const input = document.createElement('input');
        input.type = type === 'amount' ? 'tel' : 'text';
        if (type === 'amount') input.inputMode = 'tel';
        input.autocomplete = 'off';
        input.className = 'inline-edit-input';
        input.placeholder = placeholder;
        input.value = currentValue;

        const spinner = document.createElement('span');
        spinner.className = 'inline-edit-spinner hidden';

        form.append(input, spinner);

        const tearDown = () => {
          form.remove();
          btn.classList.remove('hidden');
          row.classList.remove('is-editing');
          if (activeInlineEdit && activeInlineEdit.form === form) {
            activeInlineEdit = null;
          }
          form.classList.remove('is-saving');
          spinner.classList.add('hidden');
        };

        let submitting = false;
        const handleSubmit = async () => {
          if (submitting) return;
          const value = input.value.trim();
          if (!value && type === 'amount') {
            tearDown();
            return;
          }
          submitting = true;
          form.classList.add('is-saving');
          spinner.classList.remove('hidden');
          row.classList.add('is-editing');
          try {
            const updated = await updateEntry(entryId, type === 'amount' ? { amount: value } : { name: value });
            applyEntryUpdate(row, updated);
            tearDown();
          } catch (err) {
            console.error('Update failed', err);
            submitting = false;
            form.classList.remove('is-saving');
            spinner.classList.add('hidden');
          }
        };

        form.addEventListener('submit', (evt) => {
          evt.preventDefault();
          handleSubmit();
        });

        input.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') {
            tearDown();
          } else if (evt.key === 'Enter') {
            evt.preventDefault();
            handleSubmit();
          }
        });

        input.addEventListener('blur', () => {
          handleSubmit();
        });

        btn.insertAdjacentElement('afterend', form);
        input.focus();
        input.select();
        activeInlineEdit = { form, btn };
        return form;
      };

      document.addEventListener('click', (evt) => {
        if (!currentCanEdit) return;
        const nameBtn = evt.target.closest('[data-edit-name]');
        if (nameBtn) {
          createInlineEditor({
            btn: nameBtn,
            type: 'name',
            placeholder: 'e.g. Breakfast',
          });
          return;
        }
        const amountBtn = evt.target.closest('[data-edit-amount]');
        if (amountBtn) {
          createInlineEditor({
            btn: amountBtn,
            type: 'amount',
            placeholder: 'e.g. 250, -120',
          });
        }
      });

      dots.forEach((dot) => {
        const handle = () => {
          const date = dot.dataset.date;
          const userId = dot.dataset.userId;
          if (!date || !userId) return;
          currentDate = date;
          currentUserId = userId;
          currentLabel = dot.dataset.userLabel || 'Shared';
          currentCanEdit = dot.dataset.isSelf === 'true';
          setActiveDay(userId, date, currentLabel);
          loadEntries(userId, date, currentCanEdit);
        };
        dot.addEventListener('click', handle);
        dot.addEventListener('keypress', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            handle();
          }
        });
      });

      renderEntries(initialEntries, true);
      setActiveDay(currentUserId, currentDate, currentLabel);
      startEntryEvents();

      const initialDay = todayStr;
      setInterval(() => {
        const today = new Date().toISOString().slice(0, 10);
        if (today !== initialDay) {
          window.location.reload();
        }
      }, 60_000);
    })();
  </script>
<%- include('partials/footer') %>
