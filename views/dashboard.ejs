<%- include('partials/header', { title: 'Dashboard' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Today</p>
          <h2>Calorie balance</h2>
        </div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Goal</div>
          <div class="stat-value"><%= user.daily_goal ? `${user.daily_goal} kcal` : 'Not set' %></div>
        </div>
        <div class="stat">
          <div class="stat-label">Logged today</div>
          <div class="stat-value"><%= todayTotal %> kcal</div>
        </div>
        <div class="stat">
          <div class="stat-label">Status</div>
          <% if (!user.daily_goal) { %>
            <div class="chip">Set a goal</div>
          <% } else if (goalStatus === 'under') { %>
            <div class="chip success">Under goal</div>
            <div class="muted small">Room left: <%= goalDelta %> kcal</div>
          <% } else { %>
            <div class="chip danger">Over goal</div>
            <div class="muted small">Over by <%= goalDelta %> kcal</div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Log</p>
        <h2>Add calories</h2>
      </div>
    </div>
    <form action="/entries" method="POST" class="stack horizontal">
      <label class="field">
        <span>Amount</span>
        <input
          type="text"
          name="amount"
          inputmode="decimal"
          autocomplete="off"
          required
          placeholder="e.g. 250, -200, (3*4)/6">
      </label>
      <div class="input-keypad" data-keypad>
        <% ['(', ')', '+', '-', '*', '/'].forEach((key) => { %>
          <button type="button" class="ghost small" data-keypad-key="<%= key %>"><%= key %></button>
        <% }) %>
      </div>
      <label class="field">
        <span>Name (optional)</span>
        <input type="text" name="entry_name" maxlength="120" placeholder="e.g. Breakfast, Run, Snack">
      </label>
      <label class="field">
        <span>Date</span>
        <input type="date" name="entry_date" value="<%= new Date().toISOString().slice(0,10) %>">
      </label>
      <button type="submit" class="primary">Record</button>
    </form>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Recent</p>
        <h2>Last 14 days</h2>
      </div>
    </div>
    <div class="dot-row">
      <% dailyStats.forEach((day) => { %>
        <div class="dot-wrap" role="button" tabindex="0" data-day-dot data-date="<%= day.date %>" data-tip="<%= day.date %>">
          <% if (!user.daily_goal) { %>
            <div class="dot muted"></div>
          <% } else if (day.status === 'zero') { %>
            <div class="dot zero"></div>
          <% } else if (day.status === 'under') { %>
            <div class="dot success"></div>
          <% } else if (day.status === 'over_threshold') { %>
            <div class="dot danger"></div>
          <% } else { %>
            <div class="dot warn"></div>
          <% } %>
        </div>
      <% }) %>
    </div>
    <div class="day-selected" data-day-selected>Showing <%= selectedDate === new Date().toISOString().slice(0,10) ? 'today' : selectedDate %></div>
    <div class="entry-list <%= (!recentEntries || recentEntries.length === 0) ? 'hidden' : '' %>" data-entry-list>
      <% if (recentEntries && recentEntries.length > 0) { %>
        <% recentEntries.forEach((entry) => { %>
          <div class="entry-row">
            <div>
              <div class="entry-name"><%= entry.entry_name || 'Untitled' %></div>
              <div class="muted small"><%= entry.entry_date.toISOString().slice(0,10) %></div>
            </div>
            <div class="entry-actions">
              <div class="entry-amount <%= entry.amount >= 0 ? 'pos' : 'neg' %>"><%= entry.amount %> kcal</div>
              <form action="/entries/<%= entry.id %>/delete" method="POST" class="inline-form" data-delete-form>
                <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="<%= entry.id %>">Delete</button>
              </form>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
    <div class="muted <%= (!recentEntries || recentEntries.length === 0) ? '' : 'hidden' %>" data-entry-empty>No entries yet.</div>
  </section>

  <script>
    (() => {
      const dots = Array.from(document.querySelectorAll('[data-day-dot]'));
      const entryLists = Array.from(document.querySelectorAll('[data-entry-list]'));
      const emptyState = document.querySelector('[data-entry-empty]');
      const daySelected = document.querySelector('[data-day-selected]');
      let currentDate = '<%= selectedDate %>';
      const keypad = document.querySelector('[data-keypad]');
      const amountInput = document.querySelector('input[name="amount"]');

      const renderEntries = (entries) => {
        const list = entryLists[0];
        if (!list) return;
        list.innerHTML = '';

        if (!entries || entries.length === 0) {
          list.classList.add('hidden');
          if (emptyState) {
            emptyState.textContent = 'No entries yet.';
            emptyState.classList.remove('hidden');
          }
          return;
        }

        if (emptyState) emptyState.classList.add('hidden');
        list.classList.remove('hidden');

        list.innerHTML = entries
          .map(
            (entry) => `
            <div class="entry-row">
              <div>
                <div class="entry-name">${entry.name ? entry.name : 'Untitled'}</div>
                <div class="muted small">${entry.date}</div>
              </div>
              <div class="entry-actions">
                <div class="entry-amount ${entry.amount >= 0 ? 'pos' : 'neg'}">${entry.amount} kcal</div>
                <form action="/entries/${entry.id}/delete" method="POST" class="inline-form" data-delete-form>
                  <button type="submit" class="ghost danger small" data-delete-entry data-entry-id="${entry.id}">Delete</button>
                </form>
              </div>
            </div>
          `
          )
          .join('');
      };

      const setActiveDay = (date) => {
        dots.forEach((dot) => {
          dot.classList.toggle('active', dot.dataset.date === date);
        });
        if (daySelected) {
          const today = new Date().toISOString().slice(0, 10);
          daySelected.textContent = `Showing ${date === today ? 'today' : date}`;
        }
      };

      const loadEntries = async (date) => {
        try {
          const res = await fetch(`/entries/day?date=${encodeURIComponent(date)}`, {
            headers: { Accept: 'application/json' },
          });
          if (!res.ok) return;
          const data = await res.json();
          if (data.ok) {
            renderEntries(data.entries);
          }
        } catch (err) {
          console.error('Failed to load entries', err);
        }
      };

      if (keypad && amountInput) {
        keypad.addEventListener('click', (evt) => {
          const key = evt.target.getAttribute('data-keypad-key');
          if (!key) return;
          amountInput.focus();
          const start = amountInput.selectionStart ?? amountInput.value.length;
          const end = amountInput.selectionEnd ?? amountInput.value.length;
          const before = amountInput.value.slice(0, start);
          const after = amountInput.value.slice(end);
          amountInput.value = `${before}${key}${after}`;
          const pos = start + key.length;
          amountInput.setSelectionRange(pos, pos);
        });
      }

      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const date = dot.dataset.date;
          if (!date || date === currentDate) return;
          currentDate = date;
          setActiveDay(date);
          loadEntries(date);
        });
        dot.addEventListener('keypress', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            dot.click();
          }
        });
      });

      document.addEventListener('submit', async (evt) => {
        const form = evt.target.closest('[data-delete-form]');
        if (!form) return;
        evt.preventDefault();
        const btn = form.querySelector('[data-delete-entry]');
        const entryId = btn?.dataset.entryId;
        if (!entryId) return;
        try {
          const res = await fetch(`/entries/${entryId}/delete`, {
            method: 'POST',
            headers: { Accept: 'application/json' },
          });
          if (res.ok) {
            loadEntries(currentDate);
          }
        } catch (err) {
          console.error('Delete failed', err);
        }
      });

      setActiveDay(currentDate);
    })();
  </script>
<%- include('partials/footer') %>
