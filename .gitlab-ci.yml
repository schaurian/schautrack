stages:
  - release
  - build
  - cleanup

variables:
  GIT_DEPTH: "0"

semver-tag:
  stage: release
  image: alpine:3.19
  before_script:
    - apk add --no-cache git curl bash
  script:
    - chmod +x scripts/bump-version.sh scripts/generate-changelog.sh
    - VERSION=$(scripts/bump-version.sh)
    - echo "$VERSION" > version.txt
    - scripts/generate-changelog.sh "$VERSION" > changelog.md
    - |
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@example.com}"
      git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"
    - git tag -a "$VERSION" -m "Release $VERSION"
    - |
      PUSH_TOKEN="${GIT_PUSH_TOKEN:-${GL_RELEASE_TOKEN:-$CI_JOB_TOKEN}}"
      if [ "$PUSH_TOKEN" = "$CI_JOB_TOKEN" ]; then
        PUSH_USER="${GIT_PUSH_USER:-gitlab-ci-token}"
      else
        PUSH_USER="${GIT_PUSH_USER:-oauth2}"
      fi
      git push "https://${PUSH_USER}:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$VERSION"
    - |
      if [ -n "${GL_RELEASE_TOKEN:-}" ]; then
        curl --header "PRIVATE-TOKEN: ${GL_RELEASE_TOKEN}" \
          --data-urlencode "name=$VERSION" \
          --data-urlencode "tag_name=$VERSION" \
          --data-urlencode "description=$(cat changelog.md)" \
          --request POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      fi
  artifacts:
    paths:
      - version.txt
      - changelog.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

container-build-default:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  needs:
    - semver-tag
  script:
    - VERSION=$(cat version.txt)
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}:${VERSION}"
      --destination "${CI_REGISTRY_IMAGE}:latest"
      --build-arg "BUILD_VERSION=${VERSION#v}"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
      when: on_success

container-build-branch:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  script:
    - STAGING_TAG="${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_IID}"
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}:${STAGING_TAG}"
      --build-arg "BUILD_VERSION=${STAGING_TAG}"
  rules:
    # This runs on the staging branch and creates tags like "staging-42"
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
      when: on_success
    # This keeps your existing logic for other non-default branches
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_BRANCH != "staging"'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
      when: on_success
cleanup-staging-tags:
  stage: cleanup
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl bash jq
  script:
    - chmod +x scripts/cleanup-staging-tags.sh
    - bash scripts/cleanup-staging-tags.sh
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: on_success

cleanup-semver-tags:
  stage: cleanup
  image: alpine:3.19
  before_script:
    - apk add --no-cache curl bash jq
  script:
    - chmod +x scripts/cleanup-semver-tags.sh
    - bash scripts/cleanup-semver-tags.sh
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
