stages:
  - renovate
  - release
  - build
  - manifest

variables:
  GIT_DEPTH: "0"

renovate:
  stage: renovate
  image: renovate/renovate:42.82.3
  variables:
    RENOVATE_PLATFORM: gitlab
    RENOVATE_ENDPOINT: ${CI_API_V4_URL}
    RENOVATE_REPOSITORIES: ${CI_PROJECT_PATH}
    LOG_LEVEL: info
  script:
    - renovate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web" && $RUN_RENOVATE == "true"'
      when: always

compute-version:
  stage: release
  image: alpine:3.23
  before_script:
    - apk add --no-cache git bash
  script:
    - chmod +x scripts/bump-version.sh
    - VERSION=$(scripts/bump-version.sh)
    - echo "$VERSION" > version.txt
  artifacts:
    paths:
      - version.txt
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success

container-build-default-amd64:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.24.0-debug
    entrypoint: [""]
  needs:
    - compute-version
  script:
    - VERSION=$(cat version.txt)
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}-amd64"
      --custom-platform "linux/amd64"
      --build-arg "BUILD_VERSION=${VERSION#v}"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success

container-build-default-arm64:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.24.0-debug
    entrypoint: [""]
  tags:
    - saas-linux-small-arm64
  needs:
    - compute-version
  script:
    - VERSION=$(cat version.txt)
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}-arm64"
      --build-arg "BUILD_VERSION=${VERSION#v}"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success

manifest-default:
  stage: manifest
  image:
    name: mplatform/manifest-tool:alpine-v2.1.6
    entrypoint: [""]
  needs:
    - container-build-default-amd64
    - container-build-default-arm64
    - compute-version
  script:
    - VERSION=$(cat version.txt)
    - |
      manifest-tool --username "${CI_REGISTRY_USER}" --password "${CI_REGISTRY_PASSWORD}" \
        push from-args \
        --platforms linux/amd64,linux/arm64 \
        --template "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}-ARCH" \
        --target "${CI_REGISTRY_IMAGE}:${VERSION}"
    - |
      manifest-tool --username "${CI_REGISTRY_USER}" --password "${CI_REGISTRY_PASSWORD}" \
        push from-args \
        --platforms linux/amd64,linux/arm64 \
        --template "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}-ARCH" \
        --target "${CI_REGISTRY_IMAGE}:latest"
  artifacts:
    paths:
      - version.txt
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success

semver-tag:
  stage: manifest
  image: alpine:3.23
  needs:
    - manifest-default
  before_script:
    - apk add --no-cache git curl bash
  script:
    - VERSION=$(cat version.txt)
    - chmod +x scripts/generate-changelog.sh
    - scripts/generate-changelog.sh "$VERSION" > changelog.md
    - |
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@example.com}"
      git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"
    - git tag -a "$VERSION" -m "Release $VERSION"
    - |
      PUSH_TOKEN="${GIT_PUSH_TOKEN:-${GL_RELEASE_TOKEN:-$CI_JOB_TOKEN}}"
      if [ "$PUSH_TOKEN" = "$CI_JOB_TOKEN" ]; then
        PUSH_USER="${GIT_PUSH_USER:-gitlab-ci-token}"
      else
        PUSH_USER="${GIT_PUSH_USER:-oauth2}"
      fi
      git push "https://${PUSH_USER}:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$VERSION"
    - |
      if [ -n "${GL_RELEASE_TOKEN:-}" ]; then
        curl --header "PRIVATE-TOKEN: ${GL_RELEASE_TOKEN}" \
          --data-urlencode "name=$VERSION" \
          --data-urlencode "tag_name=$VERSION" \
          --data-urlencode "description=$(cat changelog.md)" \
          --request POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

container-build-branch:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.24.0-debug
    entrypoint: [""]
  script:
    - STAGING_TAG="${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_IID}"
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}:${STAGING_TAG}"
      --build-arg "BUILD_VERSION=${STAGING_TAG}"
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[bump:(major|minor|patch)\]/'
      when: never
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_BRANCH != "staging"'
      changes:
        - Dockerfile
        - package.json
        - package-lock.json
        - src/**/*
        - .gitlab-ci.yml
      when: on_success
