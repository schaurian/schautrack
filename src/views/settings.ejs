<%- include('partials/header', { title: 'Settings' }) %>
  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Daily goal</h2>
        </div>
      </div>
      <form action="/goal" method="POST" class="stack">
        <label class="field">
          <span>Goal in kcal</span>
          <input type="text" inputmode="numeric" pattern="[0-9/*]*" name="goal" placeholder="e.g. 2200" value="<%= user.daily_goal || '' %>">
        </label>
        <button type="submit" class="primary">Save goal</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Two-factor</h2>
        </div>
      </div>

      <div class="stack">
        <% if (user.totp_enabled) { %>
          <div class="alert success">2FA is enabled.</div>
          <form action="/2fa/disable" method="POST" class="stack compact">
            <label class="field">
              <span>Current 2FA code</span>
              <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
            </label>
            <button type="submit" class="ghost danger">Disable 2FA</button>
          </form>
        <% } else if (hasTempSecret) { %>
          <p class="muted small">Scan the QR code or copy the secret, then enter the 6-digit code.</p>
          <div class="totp-setup">
            <div class="qr-center">
              <% if (qrDataUrl) { %>
                <img src="<%= qrDataUrl %>" alt="2FA QR code">
              <% } %>
              <% if (otpauthUrl) { %>
                <div class="totp-secret">
                  <button type="button" class="ghost small" id="copy-totp-url" title="Copy TOTP URL">Copy URL</button>
                  <script>
                    document.getElementById('copy-totp-url').addEventListener('click', async function() {
                      const url = <%- JSON.stringify(otpauthUrl) %>;
                      try {
                        await navigator.clipboard.writeText(url);
                        this.textContent = 'Copied!';
                        setTimeout(() => this.textContent = 'Copy URL', 1500);
                      } catch (err) {
                        console.error('Copy failed', err);
                      }
                    });
                  </script>
                </div>
              <% } %>
            </div>
            <form action="/2fa/enable" method="POST" class="stack compact">
              <label class="field">
                <span>6-digit code</span>
                <input type="text" name="token" inputmode="numeric" pattern="[0-9]*" required placeholder="123456">
              </label>
              <button type="submit" class="primary">Activate 2FA</button>
              <a href="/2fa/cancel" class="ghost danger">Cancel</a>
            </form>
          </div>
        <% } else { %>
          <p class="muted small">Add extra security with an authenticator app.</p>
          <a class="primary" href="/2fa/setup">Start setup</a>
        <% } %>
      </div>
    </div>
  </section>

  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Change password</h2>
        </div>
      </div>
      <% if (passwordFeedback) { %>
        <div class="alert <%= passwordFeedback.type === 'error' ? 'danger' : 'success' %>"><%= passwordFeedback.message %></div>
      <% } %>
      <form action="/settings/password" method="POST" class="stack">
        <label class="field">
          <span>Current password</span>
          <input type="password" name="current_password" required autocomplete="current-password">
        </label>
        <label class="field">
          <span>New password</span>
          <input type="password" name="new_password" required autocomplete="new-password" minlength="6">
        </label>
        <label class="field">
          <span>Confirm new password</span>
          <input type="password" name="confirm_password" required autocomplete="new-password" minlength="6">
        </label>
        <button type="submit" class="primary">Update password</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Change email</h2>
        </div>
      </div>
      <p class="muted small">Current email: <strong><%= user.email %></strong></p>
      <% if (emailFeedback) { %>
        <div class="alert <%= emailFeedback.type === 'error' ? 'danger' : 'success' %>"><%= emailFeedback.message %></div>
      <% } %>
      <form action="/settings/email/request" method="POST" class="stack">
        <label class="field">
          <span>New email address</span>
          <input type="email" name="new_email" required autocomplete="email" placeholder="newemail@example.com">
        </label>
        <label class="field">
          <span>Current password</span>
          <input type="password" name="password" required autocomplete="current-password">
        </label>
        <% if (user.totp_enabled) { %>
          <label class="field">
            <span>2FA code</span>
            <input type="text" name="totp_code" required autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="6-digit code">
          </label>
        <% } %>
        <button type="submit" class="primary">Send verification code</button>
      </form>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <h2>Link accounts</h2>
      </div>
      <div class="chip muted">Up to <%= maxLinks %></div>
    </div>

    <% if (linkFeedback) { %>
      <div class="alert <%= linkFeedback.type === 'error' ? 'danger' : 'success' %>"><%= linkFeedback.message %></div>
    <% } %>

    <form action="/settings/link/request" method="POST" class="stack link-form">
      <label class="field">
        <span>Invite by email</span>
        <input type="email" name="email" placeholder="friend@example.com" required <%= availableSlots === 0 ? 'disabled' : '' %>>
      </label>
      <div class="muted small">
        Linked accounts: <%= maxLinks - availableSlots %>/<%= maxLinks %>. <%= availableSlots === 0 ? 'Remove one to invite another.' : `You can invite ${availableSlots} more.` %>
      </div>
      <div>
        <button type="submit" class="primary" <%= availableSlots === 0 ? 'disabled' : '' %>>Send request</button>
      </div>
    </form>

    <div class="grid two">
      <div class="table">
        <div class="table-row header linked-row">
          <div>Incoming requests</div>
          <div></div>
        </div>
        <% if (!incomingRequests || incomingRequests.length === 0) { %>
          <div class="table-row linked-row">
            <div class="muted small">No incoming requests.</div>
            <div></div>
          </div>
        <% } else { %>
          <% incomingRequests.forEach((req) => { %>
            <div class="table-row linked-row">
              <div>
                <div class="table-email"><%= req.email %></div>
                <div class="muted small">Requested <%= req.created_at ? req.created_at.toISOString().slice(0,10) : '' %></div>
              </div>
              <div class="table-actions">
                <form action="/settings/link/respond" method="POST" class="inline-form">
                  <input type="hidden" name="request_id" value="<%= req.id %>">
                  <input type="hidden" name="action" value="accept">
                  <button type="submit" class="primary">Accept</button>
                </form>
                <form action="/settings/link/respond" method="POST" class="inline-form">
                  <input type="hidden" name="request_id" value="<%= req.id %>">
                  <input type="hidden" name="action" value="decline">
                  <button type="submit" class="ghost danger">Decline</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <div class="table">
        <div class="table-row header linked-row">
          <div>Sent requests</div>
          <div></div>
        </div>
        <% if (!outgoingRequests || outgoingRequests.length === 0) { %>
          <div class="table-row linked-row">
            <div class="muted small">No pending requests.</div>
            <div></div>
          </div>
        <% } else { %>
          <% outgoingRequests.forEach((req) => { %>
            <div class="table-row linked-row">
              <div>
                <div class="table-email"><%= req.email %></div>
                <div class="muted small">Sent <%= req.created_at ? req.created_at.toISOString().slice(0,10) : '' %></div>
              </div>
              <div class="table-actions">
                <form action="/settings/link/remove" method="POST" class="inline-form">
                  <input type="hidden" name="link_id" value="<%= req.id %>">
                  <button type="submit" class="ghost danger">Cancel</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <div class="table" style="margin-top: 14px;">
      <div class="table-row header linked-row">
        <div>Linked accounts</div>
        <div></div>
      </div>
      <% if (!acceptedLinks || acceptedLinks.length === 0) { %>
        <div class="table-row">
          <div class="muted">No linked accounts yet.</div>
          <div></div>
          <div></div>
        </div>
      <% } else { %>
        <% acceptedLinks.forEach((link) => { %>
          <div class="table-row linked-row">
            <div class="table-email"><%= link.email %></div>
            <div style="text-align: right;">
              <form action="/settings/link/remove" method="POST" class="inline-form">
                <input type="hidden" name="link_id" value="<%= link.linkId %>">
                <button type="submit" class="ghost danger">Remove</button>
              </form>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </section>

  <section class="grid two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Preferences</h2>
        </div>
      </div>
      <form action="/settings/preferences" method="POST" class="stack compact">
        <div class="field">
          <span>Timezone</span>
          <select name="timezone" class="timezone-select">
            <% timezones.forEach((tz) => { %>
              <option value="<%= tz %>" <%= (user.timezone || 'UTC') === tz ? 'selected' : '' %>><%= tz %></option>
            <% }) %>
          </select>
          <p class="muted small">Affects how timestamps display across the app.</p>
        </div>
        <div class="field">
          <span>Preferred weight unit</span>
          <div class="pill-group" data-weight-unit>
            <label class="pill <%= (user.weight_unit || 'lb') === 'lb' ? 'active' : '' %>">
              <input type="radio" name="weight_unit" value="lb" <%= (user.weight_unit || 'lb') === 'lb' ? 'checked' : '' %>> Pounds (lb)
            </label>
            <label class="pill <%= user.weight_unit === 'kg' ? 'active' : '' %>">
              <input type="radio" name="weight_unit" value="kg" <%= user.weight_unit === 'kg' ? 'checked' : '' %>> Kilograms (kg)
            </label>
          </div>
          <p class="muted small">Affects how weights display across the app.</p>
        </div>
        <button type="submit" class="primary">Save</button>
      </form>
      <div class="data-card stack danger-card spaced-top">
        <p class="muted">Need to delete your account? You can request deletion without logging in.</p>
        <a class="ghost danger full" href="/delete">Open deletion request page</a>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Backup &amp; restore</h2>
        </div>
      </div>
      <div class="data-actions">
        <form action="/settings/export" method="GET" class="data-card stack">
          <p class="muted">Download your entries and goal as JSON.</p>
          <button type="submit" class="primary full">Export JSON</button>
        </form>
        <form id="import-form" action="/settings/import" method="POST" enctype="multipart/form-data" class="data-card stack">
          <p class="muted danger-text">Import a saved export (.json). This will delete all current entries and replace them with the file.</p>
          <input class="file-input" type="file" name="import_file" accept="application/json" required>
          <button type="submit" class="primary full">Import JSON</button>
        </form>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <h2>AI settings</h2>
      </div>
    </div>
    <% if (aiFeedback) { %>
      <div class="alert <%= aiFeedback.type === 'error' ? 'danger' : 'success' %>"><%= aiFeedback.message %></div>
    <% } %>
    <form action="/settings/ai" method="POST" class="stack compact">
      <div class="field">
        <span>AI provider</span>
        <select name="preferred_ai_provider" data-ai-provider-select>
          <option value="openai" <%= (user.preferred_ai_provider || 'openai') === 'openai' ? 'selected' : '' %>>OpenAI (GPT-4o)</option>
          <option value="claude" <%= user.preferred_ai_provider === 'claude' ? 'selected' : '' %>>Claude (Sonnet)</option>
        </select>
        <p class="muted small">Choose which AI service to use for photo analysis.</p>
      </div>
      <label class="field" data-ai-key-openai style="<%= user.preferred_ai_provider === 'claude' ? 'display: none;' : '' %>">
        <span>OpenAI API Key</span>
        <input type="password" name="openai_api_key" placeholder="<%= user.hasOpenaiKey ? '••••••••' + user.openaiKeyLast4 : 'sk-...' %>" autocomplete="off">
        <p class="muted small"><%= user.hasOpenaiKey ? 'Key configured. Leave blank to keep current.' : 'Get your key at platform.openai.com' %></p>
      </label>
      <label class="field" data-ai-key-claude style="<%= user.preferred_ai_provider !== 'claude' ? 'display: none;' : '' %>">
        <span>Claude API Key</span>
        <input type="password" name="claude_api_key" placeholder="<%= user.hasClaudeKey ? '••••••••' + user.claudeKeyLast4 : 'sk-ant-...' %>" autocomplete="off">
        <p class="muted small"><%= user.hasClaudeKey ? 'Key configured. Leave blank to keep current.' : 'Get your key at console.anthropic.com' %></p>
      </label>
      <div class="stack horizontal" style="gap: var(--space-sm);">
        <button type="submit" class="primary">Save AI settings</button>
        <% if (user.hasOpenaiKey || user.hasClaudeKey) { %>
          <button type="submit" name="clear_keys" value="true" class="ghost danger">Clear all keys</button>
        <% } %>
      </div>
    </form>
  </section>

  <script>
    (() => {
      const importForm = document.getElementById('import-form');
      if (importForm) {
        importForm.addEventListener('submit', (evt) => {
          const ok = confirm('Importing will DELETE all current entries and replace them with the backup file. Continue?');
          if (!ok) {
            evt.preventDefault();
          }
        });
      }

      const unitGroup = document.querySelector('[data-weight-unit]');
      if (unitGroup) {
        unitGroup.addEventListener('change', (evt) => {
          if (evt.target.name !== 'weight_unit') return;
          unitGroup.querySelectorAll('.pill').forEach((pill) => pill.classList.remove('active'));
          const label = evt.target.closest('.pill');
          if (label) label.classList.add('active');
        });
      }

      const aiProviderSelect = document.querySelector('[data-ai-provider-select]');
      const openaiKeyField = document.querySelector('[data-ai-key-openai]');
      const claudeKeyField = document.querySelector('[data-ai-key-claude]');
      if (aiProviderSelect && openaiKeyField && claudeKeyField) {
        aiProviderSelect.addEventListener('change', () => {
          const isOpenai = aiProviderSelect.value === 'openai';
          openaiKeyField.style.display = isOpenai ? '' : 'none';
          claudeKeyField.style.display = isOpenai ? 'none' : '';
        });
      }

      // Copy button for TOTP secret
      document.querySelectorAll('[data-copy]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const text = btn.getAttribute('data-copy');
          try {
            await navigator.clipboard.writeText(text);
            const original = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = original, 1500);
          } catch (err) {
            console.error('Copy failed', err);
          }
        });
      });
    })();
  </script>
<%- include('partials/footer') %>
