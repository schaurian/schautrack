name: Helm Chart

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'helm/**'
      - '.github/workflows/helm.yml'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Determine channel
        id: channel
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "channel=stable" >> $GITHUB_OUTPUT
            echo "path=." >> $GITHUB_OUTPUT
          else
            echo "channel=staging" >> $GITHUB_OUTPUT
            echo "path=staging" >> $GITHUB_OUTPUT
          fi

      - name: Update chart version for staging
        if: github.ref == 'refs/heads/staging'
        run: |
          # Append run number to version for staging
          VERSION=$(grep '^version:' helm/schautrack/Chart.yaml | awk '{print $2}')
          sed -i "s/^version: .*/version: ${VERSION}-staging.${{ github.run_number }}/" helm/schautrack/Chart.yaml

      - name: Package Helm chart
        run: |
          mkdir -p .helm-packages
          helm package helm/schautrack -d .helm-packages

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update Helm repo
        run: |
          CHANNEL_PATH="gh-pages/${{ steps.channel.outputs.path }}"
          mkdir -p "$CHANNEL_PATH"

          # Copy new package
          cp .helm-packages/*.tgz "$CHANNEL_PATH/"

          # Update or create index
          if [ -f "$CHANNEL_PATH/index.yaml" ]; then
            helm repo index "$CHANNEL_PATH" --url "https://schaurian.github.io/schautrack/${{ steps.channel.outputs.path }}" --merge "$CHANNEL_PATH/index.yaml"
          else
            helm repo index "$CHANNEL_PATH" --url "https://schaurian.github.io/schautrack/${{ steps.channel.outputs.path }}"
          fi

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git add .
          git commit -m "Update Helm chart (${{ steps.channel.outputs.channel }})" || exit 0
          git push
